<script>

/* MODULE */

const reportsPage = ( () => {

  /* EVENT HANDLERS */

  function changeReportYear() {
    
    app.currentYear = $('#cbo-years').val()
    render()
  }

  /* RENDER PAGE */

  function render() {
  
    /* CONTROLS */ 

    let controls = '<select class="cbo" id="cbo-years" name="years">'

    app.years.forEach( (year) => {
      controls += `<option>${year.year}</option>`
    })

    controls += '</select>'

    $('.controls').html(controls)
    $('#cbo-years').val(app.currentYear)

    /* CONTENT */

    const summaryByAccount = {}
    const year = parseInt(app.currentYear)

    const eventsByYear = app.events.filter( (event) => {
      if (event.fiscal_year === year) {
        return event
      }
    })

    eventsByYear.forEach( (event) => {
      if (summaryByAccount[event.account_id]) {
        summaryByAccount[event.account_id].tot += event.total
        summaryByAccount[event.account_id].a += event.a_share
        summaryByAccount[event.account_id].b += event.total - event.a_share
      }else{
        summaryByAccount[event.account_id] = {tot:event.total, a:event.a_share, b:(event.total - event.a_share)}
      }
    })


    const sums = {tot:0, a:0, b:0}
    for (const key in summaryByAccount) {
      sums.tot += summaryByAccount[key].tot
      sums.a += summaryByAccount[key].a
      sums.b += summaryByAccount[key].b
    }

    summaryByAccount.Totals = sums

    let content = `
      <table id="tbl-reports">
      <tr>
        <th>Tili</th>
        <th>Summa</th>
        <th>A-osuus</th>
        <th>B-osuus</th>
      </tr>`

    app.accounts.forEach( (account) => {
      if (summaryByAccount[account.id]) {
      content += `
      <tr id="${account.id}">
        <td>${account.name}</td>
        <td class="number"> ${summaryByAccount[account.id].tot.toFixed(2)}</td>
        <td class="number"> ${summaryByAccount[account.id].a.toFixed(2)}</td>
        <td class="number"> ${summaryByAccount[account.id].b.toFixed(2)}</td>
      </tr>`
      }
    })

    content += `
    <tr>
      <th class="total"> Yhteens√§ </th>
      <th class="total"> ${summaryByAccount.Totals.tot.toFixed(2) } </th>
      <th class="total"> ${ summaryByAccount.Totals.a.toFixed(2) } </th>
      <th class="total"> ${ summaryByAccount.Totals.b.toFixed(2) } </th>
    </tr>
    </table>`

    $('.content').html(content)

    /* EVENT LISTENERS */

    $('#cbo-years').on('change', changeReportYear)

  }

  /* API */
  return {render: render}

})()
</script>