<script>
class EventsView { 

  constructor(controller) {
    this.controller = controller
  }

  render(events, years, currentYear) {
    this.renderControls(years, currentYear)
    this.renderContent(events)
    this.setEventListeners()
  }

  renderControls(years, currentYear) {
    let options  =''
    for(const year of years) {
      options += `
        <option>
          ${year.year}
        </option>
      `
    }

    const select = `
      <select class="cbo" id="cbo-years" name="years">
        ${options}
      </select>
    `
    const buttons = `
      <button class="btn" id="btn-add" hidden>Lis채채...</button>
      <button class="btn" id="btn-export" hidden>Vie taulukkoon</button> 
    `
    const controls = `
      ${select}
      ${buttons}
    `
    $('.controls').html(controls)
    $('#cbo-years').val(currentYear)
  }

  renderContent(events) {
    const headerLine = `
      <tr>
        <th>Tosite</th>
        <th>P채iv채ys</th>
        <th>Tapahtuma</th>
        <th>Summa</th>
        <th>A-asunto</th>
        <th>Tili</th>
        <th>Kommentti</th>
        <th>Tilivuosi</th>
        <th class="charge-status" hidden>Veloitus</th>
        <th class="is-payed" hidden>Ok</th>
      </tr>
    `
    let table =''
    for (const event of events) {
      table += `
      <tr id="${event.id}">
        <td> ${event.number}</td>
        <td> ${event.date}</td>
        <td> ${event.event}</td>
        <td class="number"> ${event.total.toFixed(2)}</td>
        <td class="number"> ${event.a_share.toFixed(2)}</td>
        <td> ${event.account_name}</td>
        <td class="comment"> ${(event.comment != '') ? '*)' : ''}</td>
        <td> ${event.fiscal_year}</td>
        <td class="charge-status" hidden>${event.charging}</td>
        <td class="is-payed" hidden>${event.cleared}</td>
      </tr>`
    }

    const content = `
      <table id="tbl-events">
        ${headerLine}
        ${table}
      </table>
    `
    
    $('.content').html(content)
  }

  setEventListeners() {
    const that = this

    $('#cbo-years').on('change', function() {
        that.controller.setCurrentYear($('#cbo-years').val())
      })

    $('.comment').on('click', function() {
      that.controller.openEventComment(parseInt($(this).parent().attr('id')))
    })

    if (profile === 'admin') {
      $('td').on('dblclick', function() {
        that.controller.modifyEvent(parseInt($(this).parent().attr('id')))})

      $('#btn-add').show()
      $('#btn-add').on('click', function() {
        that.controller.addNewEvent()})

      $('#btn-export').show()
      $('#btn-export').on('click', function() {
        that.controller.exportYearlyEvents($('#cbo-years').val())
      })

      $('.charge-status').show()
      $('.charge-status').on('click', function() {
        that.controller.setEventStatus(parseInt($(this).parent().attr('id')))})

      $('.is-payed').show()
    }
  }  
}
</script>