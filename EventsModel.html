<script>

const eventsModel = (function() {

  function addEvent(event) {
    return new Promise((resolve, reject) => {

      google.script.run
      .withSuccessHandler( newEvent => {
        app.events.push(newEvent)
        resolve()
      })
      .withFailureHandler( err => {reject(err)})
      .apiCall('insertEvent', event)
    })
  }

  function changeEventStatus(id) {
    return new Promise((resolve,reject) => {

      const index = getTableIndex(app.events, id)
      const event = app.events[index]

      //selvitä, onko muutos sallittu
      if (event.cleared === '') {

        //aseta status -> päälle/pois
        const status = (event.charging === 'x') ? '' : 'x'
        app.events[index].charging = status

        //lähetä tieto serverille
        google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(err => {reject(err)})
        .apiCall('setChargingStatus', {id:id, status:status})
      }
    })
  }

  function changeCurrentYear(year) {
    app.currentYear = year
  }

  function getEvent(id) {
    const index = getTableIndex(app.events, id)
    const record = app.events[index]

    return record
  }

  function getEvents() {
    return new Promise((resolve, reject) => {
      
      google.script.run
      .withSuccessHandler( events => {
        app.events = events
        resolve(events)
        })
      .withFailureHandler( err => {reject(err)})
      .apiCall('getEvents')
    })
  }

  function updateEvent(event) {
    return new Promise((resolve, reject) => {

    const index = getTableIndex(app.events, event.id)
    app.events[index] = event
    google.script.run
      .withFailureHandler( err => {reject(err)})
      .apiCall('updateEvent', event)     
    })
  }

return {
  addEvent: addEvent,
  changeEventStatus: changeEventStatus,
  changeCurrentYear: changeCurrentYear,
  getEvent: getEvent,
  getEvents: getEvents,
  updateEvent: updateEvent
}
})()

</script>