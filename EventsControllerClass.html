<script>

class EventsController {

  constructor() {
    this.model = new EventsModel()
  }

  addNewEvent() {
    const event = {}
    event.id = 0
    event.number = ''
    event.date = ''
    event.event= ''
    event.total = 0
    event.a_share = 0
    event.account_id = 1
    event.comment = ''
    event.fiscal_year = app.currentYear
    event.charging = ''
    event.cleared = ''

    const eventForm = new EventFormView(this, event)
    eventForm.render()
  }
     
  setEventStatus(id) {
    this.model.setEventStatus(id)      
    this.openEventsPage()
//    const eventsView = new EventsView(this)
//    eventsView.render()
  }


  setCurrentYear(year) {
    this.model.setCurrentYear(year)
    this.openEventsPage()
//    const eventsView = new EventsView(this)
//    eventsView.render()
  }
    
  modifyEvent(id) {
    const event = this.model.getEvent(id)
    const eventForm = new EventFormView(this, event)
    eventForm.render()
  }

  openEventComment(id) {
    const event = this.model.getEvent(id)
    if (event.comment != '') {
      const eventComment = new EventCommentForm()
      eventComment.render(event)
    }
  }

  openEventsPage() {
    const eventsView = new EventsView(this)
    const events = this.model.getEvents(app.currentYear)
    eventsView.render(events, app.years, app.currentYear)
  }


  async exportYearlyEvents(year) {
    await this.model.exportYearlyEvents(year)
    alert(`Vuoden ${year} tapahtumat talletettu taulukkoon.`)
  }

  async saveEvent(event) {
    if (event.id === 0) {
      //insert
      app.spinner.on()
      await this.model.addEvent(event)
        this.openEventsPage()
//        const eventsView = new EventsView(this)
//        eventsView.render()
        app.spinner.off()
        app.popup.off()
    } else {
      //update
      this.openEventsPage()
//      const eventsView = new EventsView(this)
//      eventsView.render()
      app.popup.off()
      await this.model.updateEvent(event)
    }
  }
}

</script>