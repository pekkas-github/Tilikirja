<script>

class EventsController {

  constructor() {
    this.model = new EventsModel()
    this.currentYear = this.model.getCurrentYear()
  }

  addNewEvent() {
    const event = this.model.getNewEvent()
    const accounts = this.model.getAccounts()
    const years    = this.model.getYears()

    EventFormView.controller = this
    EventFormView.event      = event
    EventFormView.render(accounts, years)
  }
     
  setEventStatus(id) {
    this.model.setEventStatus(id)      
    this.openEventsPage(this.currentYear)
  }


  setCurrentYear(year) {
    this.model.setCurrentYear(year)
    this.openEventsPage(year)
  }
    
  modifyEvent(id) {
    const event    = this.model.getEvent(id)
    const accounts = this.model.getAccounts()
    const years    = this.model.getYears()

    EventFormView.controller = this
    EventFormView.event      = event
    EventFormView.render(accounts, years)
  }

  openEventComment(id) {
    const event = this.model.getEvent(id)
    if (event.comment != '') {
      const eventComment = new EventCommentForm()
      eventComment.render(event)
    }
  }

  openEventsPage(year) {
    const events = this.model.getEvents(year)
    const years  = this.model.getYears()
    EventsView.controller = this
    EventsView.render(events, years, year)
  }


  async exportYearlyEvents(year) {
    await this.model.exportYearlyEvents(year)
    alert(`Vuoden ${year} tapahtumat talletettu taulukkoon.`)
  }

  async saveEvent(event) {
    if (event.id === 0) {
      //insert
      app.spinner.on()
      await this.model.addEvent(event)
        this.openEventsPage(this.currentYear)
        app.spinner.off()
        app.popup.off()
    } else {
      //update
      this.model.updateEvent(event)
      this.openEventsPage(this.currentYear)
      app.popup.off()
    }
  }
}

</script>