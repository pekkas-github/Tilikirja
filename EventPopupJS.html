<script>

/* MODULE */

const eventForm = ( () => {

  let eventRecord = {}
  let recordIndex = -1


  /* EVENT HANDLERS */

  function calculateShare() {

    const total = $('#txt-total').val()
    const per = $('#cbo-percent').val()

    if (per > 0) {
      $('#txt-share').val((total * per).toFixed(2))
    }
  }


  function saveEvent() {
    
    // Read input
    eventRecord.number = parseInt($('#txt-nbr').val())
    eventRecord.date = $('#txt-day').val()
    eventRecord.event = $('#txt-event').val()
    eventRecord.total = Number($('#txt-total').val())
    eventRecord.a_share = Number($('#txt-share').val())
    eventRecord.account = $('#cbo-account').val()
    eventRecord.comment = $('#txt-comment').val()
    eventRecord.fiscal_year = parseInt($('#cbo-year').val())

    // Validate input
    if (eventRecord.date === '') {alert('P채iv채ys puuttuu'); return}
    if (eventRecord.event === '') {alert('Kuvaus puuttuu'); return}
    if (eventRecord.total === '' || isNaN(eventRecord.total)) {alert('Tarkista kokonaissumma'); return}
    if (eventRecord.a_share === '' || isNaN(eventRecord.a_share)) {alert('Tarkista A-osuus'); return}
    if (eventRecord.account === null) {alert('Tili puuttuu'); return}
    if (isNaN(eventRecord.fiscal_year)) {alert('Tilivuosi puuttuu'); return}

    // Check if new or update
    if (eventRecord.id === 0) {
      google.script.run
      .withSuccessHandler(insertEvent)
      .apiCall('insertEvent', eventRecord)
      spinner.on()
    } else {
      google.script.run
      .apiCall('updateEvent', eventRecord)

      app.events[recordIndex] = eventRecord
      eventsPage.render()
     popup.off()
    }
  }


  /* CALLBACK FUNCTIONS */

  function insertEvent (newRecord) {

    app.events.push(newRecord)
    eventsPage.render()

    spinner.off()
    popup.off()
  }


  /* RENDER POPUP */

  function render (record, index) {

    eventRecord = record
    recordIndex = index 

    let popupContent = `
      <span id="btn-popup-close">&times;</span>

      <table class="empty" id="event-form">
        <tr>
          <td class="label">Tosite:</td>
          <td class="empty"><input id="txt-nbr" type="text" value="${record.number}" size="1" disabled></td>
        </tr>
        <tr>
          <td class="label">P채iv채ys:</td>
          <td class="empty"><input id="txt-day" type="date" value="${record.date}"></td>
        </tr>
        <tr>
          <td class="label">Tapahtuma:</td>
          <td class="empty"><input id="txt-event" type="text" value="${record.event}" size="50"></td>
        </tr>
        <tr>
          <td class="label">Summa:</td>
          <td class="empty"><input id="txt-total" type="text" value="${record.total}" size="5"></td>
        </tr>
        <tr>
          <td class="label">A-osuus:</td>
          <td class="empty">
            <input id="txt-share" type="text" value="${record.a_share}" size="5">
            <select id="cbo-percent">
              <option value="0">Vapaa</option>
              <option value="0.385">38.5</option>
              <option value="0.5">50</option>
            </select>
          </td>
        </tr>
        <tr>
          <td class="label">Tili:</td>
          <td class="empty">
            <select class="cbo" id="cbo-account">`

    app.accounts.forEach( (account) => {
      popupContent += `<option>${account.Accounts}</option>`
    })

    popupContent += `
            </select>

          </td>
        </tr>
        <tr>
          <td class="label">Tilivuosi:</td>
          <td class="empty">
            <select class="cbo" id="cbo-year">`

    app.years.forEach( (year) => {
      popupContent += `<option>${year.Years}</option>` 

    })

    popupContent += `
            </select>
          </td>
        </tr>
        <tr>
          <td class="label">Kommentti:</td>
          <td class="empty"><input id="txt-comment" type="text" value="${record.comment}" size="50"></td>
        </tr>
      </table>

      <button class="btn" id="btn-popup-save">Talleta</button>`

    $('.popup-content').html(popupContent)

    $('#cbo-account').val(record.account)
    $('#cbo-year').val(record.fiscal_year)


    /* EVENT LISTENERS */

    $('#btn-popup-save').on('click', saveEvent)
    $('#btn-popup-close').on('click', popup.off)
    $('#cbo-percent').on('change', calculateShare)

    popup.on()
  }


  /* API */

  return {render: render}
  
})()
</script>