<script>

  const eventsController = (function() {

    function addNewEvent() {
      const rec = {}
      rec.id = 0
      rec.number = ''
      rec.date = ''
      rec.event= ''
      rec.total = 0
      rec.a_share = 0
      rec.account_id = 1
      rec.comment = ''
      rec.fiscal_year = app.currentYear
      rec.charging = ''
      rec.cleared = ''

      eventFormView.render(rec)
    }


    function changeEventStatus(id) {
      eventsModel.changeEventStatus(id)      
      .catch( error => {
        alert(`Server: ${error.message}`)
        reloadEvents()
      })
      eventsView.render()
    }


    function changeEventsYear(year) {
      eventsModel.changeCurrentYear(year)
      eventsView.render()
    }

    async function reloadEvents() {
      spinner.on()
      try {
        await eventsModel.getEvents()
        eventsView.render()
        spinner.off()
      }
      catch(error) {alert(error)}
    }
    


    function modifyEvent(id) {
      eventFormView.render(eventsModel.getEvent(id))
    }

    function openEventsPage() {
      eventsView.render()
    }

    function saveEvent(event) {
      if (event.id === 0) {
        //insertEvent(event)
        spinner.on()
        eventsModel.addEvent(event)
        .then(() => {
          eventsView.render()
          spinner.off()
        })
      } else {
        //updateEvent(event)
        eventsModel.updateEvent(event)
        .catch( error => {
          alert(error.message)
          reloadEvents()
        })
        eventsView.render()
      }
      popup.off()
    }

    return {
      addNewEvent: addNewEvent,
      changeEventStatus: changeEventStatus,
      changeEventsYear: changeEventsYear,
      reloadEvents: reloadEvents,
      modifyEvent: modifyEvent,
      openEventsPage: openEventsPage,
      saveEvent: saveEvent
    }
  })()

</script>