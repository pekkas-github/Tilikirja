<script>

/* MODULE */

const readingForm = ( () => {

  const readingRecord = {}

  /* EVENT HANDLERS */

  function saveReading() {

    // Read data
    readingRecord.id = 0
    readingRecord.date = $('#txt-date').val()
    readingRecord.master_reading = parseInt($('#txt-total').val())
    readingRecord.a_reading = parseInt($('#txt-a').val())
    readingRecord.b_reading = parseInt($('#txt-b').val())
    readingRecord.fiscal_year = parseInt($('#cbo-year').val())
    readingRecord.comment = $('#txt-comment').val()

    // Validate data
    if (readingRecord.date === '') { alert('Päiväys puuttuu'); return}
    if (readingRecord.master_reading === '' || isNaN(readingRecord.master_reading)) { alert('Tarkista kokonaismäärä'); return}
    if (readingRecord.a_reading === '' || isNaN(readingRecord.a_reading)) { alert('Tarkista A-osuus'); return}
    if (readingRecord.b_reading === '' || isNaN(readingRecord.b_reading)) { alert('Tarkista B-osuus'); return}

    // Send data to server
    spinner.on()

    google.script.run
    .withSuccessHandler(insertReading)
    .apiCall('insertReading', readingRecord)

  }

  /* CALLBACK FUNCTIONS */

  function insertReading(records) {

    app.events.push(records[0])
    app.water.push(records[1])

    readingsPage.render()

    spinner.off()
    popup.off()
  }


  /* RENDER POPUP */

  function render() {

    let popupContent = `
      <span id="btn-popup-close">&times;</span>

      <table class="empty">
        <tr>
          <td class="label">Lukemispäivä:</td>
          <td class="empty"><input id="txt-date" type="date"></td>
        </tr>
        <tr>
          <td class="label">Talon mittari:</td>
          <td class="empty"><input id="txt-total" type="text" size="4"></td>
        </tr>
        <tr>
          <td class="label">Asunto A:</td>
          <td class="empty"><input id="txt-a" type="text" size="4"></td>
        </tr>
        <tr>
          <td class="label">Asunto B:</td>
          <td class="empty"><input id="txt-b" type="text" size="4"></td>
        </tr>
        <tr>
          <td class="label">Tilivuosi:</td>
          <td class="empty">
            <select class="cbo" id="cbo-year">`

      app.years.forEach( (year) => {
      popupContent += `<option>${year.Years}</option>`

      })

    popupContent += `
            </select>
          </td>
        </tr>
        <tr>
          <td class="label">Kommentti:</td>
          <td class="empty"><input id="txt-comment" type="text" size="50"></td>
        </tr>
      </table>

      <button class="btn" id="btn-popup-save">Talleta</button>
    `

    $('.popup-content').html(popupContent)

    /* EVENT LISTENERS */

    $('#btn-popup-save').on('click', saveReading)
    $('#btn-popup-close').on('click', popup.off)

    popup.on()
  }

  /* API */

  return {render: render}
  
  })()
</script>