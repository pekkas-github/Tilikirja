<script>
  
  const readingsModel = (function() {

    function addReading(reading, callback) {
      // Add new reading in local table
      app.water.push(reading)

      // Add reading in server table and update the id in local table
      google.script.run
      .withFailureHandler((err) => {
        alert(err)
        freshLoad(callback)
      })
      .withSuccessHandler((res) => {
        app.water.forEach((reading) => {
          if(reading.id === 0) {
            reading.id = res.newId
          }
        })
        app.events.push(res.newEvent)
      })
      .apiCall('insertReading', reading)

      callback()
    }

    // Fresh load from server table
    function freshLoad(callback) {
      google.script.run
      .withFailureHandler((err) => {
        alert(`Server: ${err}`)
      })
      .withSuccessHandler((data) => {
        api.water = data
        callback()
      })
      .apiCall('getWaterReadings')
    }

    return {
      addReading: addReading,
      freshLoad: freshLoad
    }

  })()
</script>