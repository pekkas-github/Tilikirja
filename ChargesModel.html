<script>

const chargesModel = (function() {

  function ackCharges(date) {

    return new Promise((resolve, reject) => {
      const eventsToBeCharged = getEventsToBeCharged()
      eventsToBeCharged.forEach( (event) => {
        const tableIndex = getTableIndex(app.events, event.id)
        app.events[tableIndex].cleared = date
      })

      google.script.run
      .withFailureHandler( err => {reject(err)})
      .apiCall('ackCharges', {eventsToBeCharged: eventsToBeCharged, date: date})
    })
  }


  function getEventsToBeCharged() {

    return app.events.filter( (event) => {
      if (event.charging === 'x' && event.cleared === '') {
        return event
      }
    })
  }

  return {
    ackCharges: ackCharges,
    getEventsToBeCharged: getEventsToBeCharged
  }

})()

</script>