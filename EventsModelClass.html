<script>

class EventsModel {

  constructor() {
    this.server = new Server()
  }

  addEvent(event) {
    return new Promise((resolve, reject) => {

      this.server.apiCall('insertEvent', event)
      .then(newEvent => {
        app.events.push(newEvent)
        resolve()
      })
      .catch(err => {
        reject(err)
      })
    })    
  }

  async exportYearlyEvents(year) {
    await this.server.apiCall('exportYearlyEvents', year)
  }

  getEvent(id) {
    const index = app.getArrayIndex(app.events, id)
    const event = app.events[index]

    return event
  }


  getEvents() {
    return new Promise((resolve, reject) => {

      this.server.apiCall('getEvents')
      .then(events => {
        app.events = events
        resolve(events)
        })
      .catch(err => {
        reject(err)
      })
    })
  }


  setEventStatus(id) {
    return new Promise((resolve,reject) => {

      const index = app.getArrayIndex(app.events, id)
      const event = app.events[index]

      //if allowed
      if (event.cleared === '') {
        //then change locally
        const status = (event.charging === 'x') ? '' : 'x'
        app.events[index].charging = status

        //then change on server
        this.server.apiCall('setChargingStatus', id, status)
        .then(resolve)
        .catch(err => {
          reject(err)
        })
      }
    })
  }

  setCurrentYear(year) {
    app.currentYear = year
  }
  
  updateEvent(event) {
    return new Promise((resolve, reject) => {

      const index = app.getArrayIndex(app.events, event.id)
      app.events[index] = event
      this.server.apiCall('updateEvent', event)
      .then(resolve)
      .catch(err => {
        reject(err)
      })
    })
  }

}
</script>